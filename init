#!/bin/bash

if [ ! -e "veles/znicz/__init__.py" -o ! -e libSoundFeatureExtraction/.project -o ! -e mastodon/pom.xml ]; then
  if git remote -v | grep ssh:// >/dev/null; then
    host=$(git remote -v|head -n 1|cut -f 2|cut -d ' ' -f 1|sed -e 's/ssh:\/\///' -e 's/Veles.git$\|Veles$//' -e 's/\//\\\//g')
    sed -i "s/alserver.rnd.samsung.ru:29418\//$host/g" .gitmodules
  else
    # assuming http://
    host=$(git remote -v|head -n 1|cut -f 2|cut -d ' ' -f 1|sed -e 's/http:\/\///' -e 's/Veles.git$\|Veles$//' -e 's/\//\\\//g')
    sed -i "s/ssh:\/\/alserver.rnd.samsung.ru:29418\//http:\/\/$host/g" .gitmodules
  fi
  while ! git submodule update --init; do
    echo 'Failed to checkout submodules, retrying...'
  done
else
    git submodule update
fi
if ! grep -q package .git/config; then
    echo '[filter "package"]
        clean = /bin/sh package.sh clean
        smudge = /bin/sh package.sh smudge' >> .git/config
fi
if ! grep -q package .git/modules/Znicz/config; then
    echo '[filter "package"]
        clean = /bin/sh package.sh clean
        smudge = /bin/sh package.sh smudge' >> .git/modules/Znicz/config
fi
git checkout .gitmodules
rm -f veles/__init__.py
git checkout veles/__init__.py
cd veles/znicz
rm -f __init__.py
git checkout __init__.py
cd ../..
