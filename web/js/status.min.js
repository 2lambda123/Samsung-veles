function renderGraphviz(e){var s;try{var o=Viz(e,"svg","neato",["-n"]);s=$.parseXML(o)}catch(e){s=e}return s}function updateUI(){if(!updating){updating=!0,console.log("Update started");var e={request:"workflows",args:["name","master","slaves","time","user","graph","description","plots","custom_plots","log_id","log_addr"]};$.ajax({url:"service",type:"POST",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",async:!0,success:function(e){if(console.log("Received response",e),!e||!e.result)return updating=!1,void console.log("Server returned an empty response, skipped");e=e.result,listed_workflows=e;var s=Object.keys(e).map(function(s){return{key:s,value:e[s]}});if(0==s.length)return void(updating=!1);s.sort(function(e,s){return e.value.name>s.value.name}),null!=active_workflow_id&&active_workflow_id in e||(active_workflow_id=s[0].key);var o="";s.forEach(function(e){var s=e.value;slaves=Object.keys(s.slaves).map(function(e){return{key:e,value:s.slaves[e]}}),slaves.sort(function(e,s){return e.value.host>s.value.host}),listed_workflows[e.key].slaves=slaves;var t=0;for(var a in s.slaves)t+=s.slaves[a].value.jobs;e.key in jobs_per_minute||(jobs_per_minute[e.key]=[]),jobs_per_minute[e.key].push({time:(new Date).getTime()/6e4,jobs:t}),"undefined"==typeof svg_cache[e.key]&&(svg_cache[e.key]=$(renderGraphviz(s.graph)).find("svg")),listed_workflows[e.key].svg=svg_cache[e.key];var l=listed_workflows[e.key].svg.clone();l.attr("class","media-object pull-left"),l.attr("width","100").attr("height",100),o+='<li class="list-group-item media list-item-media',active_workflow_id==e.key&&(o+=" active"),o+='" id="',o+=e.key,o+='">\n',o+=l.wrap("<div>").parent().html(),o+='<div class="media-body graceful-overflow">\n',o+='<a class="view-plots" href="',o+=s.plots,o+='" target="_blank">plots</a>',o+='<span class="view-plots">&nbsp;</span>\n',o+='<a class="view-plots" href=log_viewer.html?id="',o+=s.log_id,o+='"target="_blank">logs</a>\n',o+='<h4 class="list-group-item-heading graceful-overflow"><a href="#" ',o+="onclick=\"activateListItem('",o+=e.key,o+="')\">",o+=s.name,o+="</a></h4>\n",o+='<span class="list-group-item-text">Master: ',o+='<a class="graceful-overflow" href="#"><strong>',o+=s.master,o+="</strong></a><br/>\n",o+='<span class="badge pull-right">';var r=0;for(var a in s.slaves)"Offline"!=s.slaves[a].value.state&&r++;o+=r,o+="</span>\n",o+="Slaves: ";var i=jobs_per_minute[e.key];if(jobs_per_minute[e.key].length>=5){for(var n=i.slice(-1)[0],c=n.time,v=c,d=2,f=0;10>=c-v&&d<=i.length;){var p=i[i.length-d];v=p.time,f=p.jobs,d++}f=n.jobs-f,o+=c>v?(f/(c-v)).toFixed(0):"N/A"}else o+="N/A";o+=" jpm<br/>\n",o+="Time running: <strong>",o+=s.time,o+="</strong><br/>\n",o+='Started by: <i class="glyphicon glyphicon-user">',o+='<a href="#" class="graceful-overflow"><strong>',o+=s.user,o+="</strong></a></i></span>\n",o+="</div>\n",o+="</li>\n"}),free_svgs=[];for(var t in svg_cache)"undefined"==typeof listed_workflows[t]&&free_svgs.push(t);for(var t in free_svgs)delete svg_cache[t];objs=$.parseHTML(o),$("#workflows-list").empty().append(objs),console.log("Finished update"),setTimeout(activateListItem,0,active_workflow_id),updating=!1}})}}function activateListItem(e){active_workflow_id!=e&&(console.log("Switching items in the list"),$("#"+active_workflow_id).removeClass("active"),active_workflow_id=e,$("#"+e).addClass("active"));var s=!0;detailed_workflow_id==e?s=!1:(detailed_workflow_id=e,$("#indicator").show());var o=listed_workflows[e];s&&($("#button-plots").off("click").on("click",function(){showPlots(e)}),$("#button-logs").off("click").on("click",function(){showLogs(e)}),$("#button-plots").off("click").on("click",function(){}),$("#button-plots").off("click").on("click",function(){}));var t=1,a=0,l=0;o.slaves.forEach(function(e){var s=e.value,o=s.power;o>t&&(t=o),"Offline"!=s.state&&(a+=e.value.jobs,l++)}),a/=l;var r=0;l>1&&(o.slaves.forEach(function(e){var s=e.value,o=s.jobs-a;r+=o*o}),r=Math.sqrt(r/(l-1)));var i="";o.slaves.forEach(function(e){var s=e.value;i+='<tr class="';var l="";switch(s.state){case"Working":l="success";break;case"Waiting":l="warning";break;case"Offline":l="danger"}s.jobs<a-2*r&&"success"==l&&(l="warning"),i+=l+'">\n',i+='<td><div class="slave-id graceful-overflow">',i+=e.key,i+="</div></td>\n",i+='<td><div class="slave-host graceful-overflow"><a href="#">',i+=s.host,i+="</a>",s.host==o.master&&(i+=' <span class="glyphicon glyphicon-flag"></span>'),i+="</div></td>\n<td>",i+='<div class="progress"><div class="progress-bar ';var n=s.power/t;i+=n>=.7?"progress-bar-success":n>=.4?"progress-bar-warning":"progress-bar-danger",i+='" role="progressbar" aria-valuenow="',i+=s.power.toFixed(0),i+='" aria-valuemin="0" aria-valuemax="',i+=t.toFixed(0),i+='" style="width: ';var c=100*s.power/t;i+=c.toFixed(0),i+='%;">',n>=.5&&(i+=s.power.toFixed(0)),i+="</div>",.5>n&&(i+='<div class="progress-bar progress-overflow" ',i+='role="progressbar" style="width: ',i+=(100-c).toFixed(0),i+='%;">',i+=s.power.toFixed(0),i+="</div>"),i+="</div>",i+='</td>\n<td class="center-cell">',i+=s.state,i+='</td>\n<td class="center-cell">\n',"Offline"!=s.state&&(i+='<a href="#"><span class="glyphicon glyphicon-pause"></span></a>\n',i+='<a href="#"><span class="glyphicon glyphicon-remove"></span></a>\n',i+='<a href="#"><span class="glyphicon glyphicon-info-sign"></span></a>\n'),i+="</td>\n",i+="</tr>\n"}),""!=i?(i=$.parseHTML(i),$("#slaves-table > table > tbody").empty().append(i),$("#slaves-panel").show()):$("#slaves-panel").hide(),$("#workflow-name").text(o.name),$("#workflow-description").html(o.description),$("#workflow-owner").text(o.user),$("#workflow-master-host").text(o.master),$("#workflow-online-nodes").text(l),$("#workflow-offline-nodes").text(Object.keys(o.slaves).length-l),$("#workflow-log-id").text(o.log_id),$("#workflow-log-id").attr("href","logs.html?session="+o.log_id),$("#workflow-zeromq-plotting-endpoints").html(o.custom_plots),$("#content").show(),s&&($("#workflow-svg-container-fill").resize(),$("#workflow-svg-container").empty().append(o.svg.clone().attr("width","100%").attr("height","100%"))),$("#indicator").hide()}function showPlots(e){var s=listed_workflows[e],o=window.open(s.plots,"_blank");o.focus()}function showLogs(e){var s=listed_workflows[e],o=window.open("logs.html?session="+s.log_id,"_blank");o.focus()}var updating=!1,active_workflow_id=null,detailed_workflow_id=null,listed_workflows=null,svg_cache={},jobs_per_minute={};$(window).load(function(){setInterval(updateUI,2e3),setTimeout(updateUI,0)});