function formatDate(e){var t=new Date(1e3*e),s=t.getMonth()+1;10>s&&(s="0"+s);var r=t.getHours();10>r&&(r="0"+r);var a=t.getMinutes();10>a&&(a="0"+a);var l=t.getSeconds();10>l&&(l="0"+l);var n=t.getMilliseconds();return 10>n&&(n="0"+n),100>n&&(n="0"+n),""+t.getDate()+"."+s+" "+r+":"+a+":"+l+"."+n}function setupUI(){if(!ui_is_setup){$("#chart-loading-master").hide(),$("#chart-loading-slave").hide(),nodes.forEach(function(e){"master"!=e.id&&$("select.slave-setter").append($.parseHTML("<option>"+e.id+"</option>"))}),nodes.length>1&&($("select.slave-setter").children().first().attr("selected","selected"),$("select.slave-setter").selectmenu("refresh").selectmenu("widget").removeAttr("style")),$("#timescale").show(),$("#preview").show(),$("#slave-setter-horizontal-centering").show(),$("#log-level").selectmenu({select:function(e,t){fetchLogs(t.item.label)}}),$("select.slave-setter").selectmenu({change:function(e,t){var s=nodes[nodes_mapping[t.item.label]];selected_slave=s,fetchEventsForNode(s,!0),fetchLogsForNode(s.id,$("#log-level option:selected").text())}});for(var e=new Rickshaw.Color.Palette({scheme:"classic9"}),t=[[],[]],s=event_names.map(function(){return e.color()}),r=0;2>r;r++)for(var a in event_names)t[r].push({color:s[a],data:series_data[r][a],name:event_names[a]});setupGraphs(t);var l=Math.log(.001),n=Math.log(elapsed_time);$("#timescale").slider({min:l,max:n,step:(n-l)/20}).on("slide",function(e,t){t.value=Math.min(Math.max(t.value,l),n);var s=Math.exp(t.value);if(s!=time_scale){var r=$("#preview"),a=r.slider("values"),o=(a[0]+a[1])/2,i=(a[1]-a[0],s/time_scale),c=r.slider("option","min"),m=r.slider("option","max"),g=o*(1-i);c=Math.max(c*i+g,0),m=Math.min(m*i+g,elapsed_time),a[1]>m&&(a[1]=m),a[0]<c&&(a[0]=c),current_min_time=a[0],current_max_time=a[1],r.slider({values:a,min:c,max:m,step:(m-c)/100}),time_scale=s}}),$("#time-interval").text(formatDate(current_min_time)+" - "+formatDate(current_max_time)),setupLogTables(),ui_is_setup=!0}}function setupLogTables(){$(".logs").css("overflow","auto");var e={theme:"jui",widthFixed:!0,headers:{0:{sorter:"digit"},1:{sorter:"text"},2:{sorter:"text"},3:{sorter:!1}},widgets:["uitheme","zebra","columns","stickyHeaders"],cancelSelection:!0,widgetOptions:{zebra:["ui-widget-content even","ui-state-default odd"],stickyHeaders_attachTo:$("#logs-master")},sortList:[[0,0]],textExtraction:{0:function(e){return $(e).attr("created")}}},t=$("#logs-contents-master").tablesorter(e);t.trigger("pagerComplete.tsSticky",null),fetching_logs.master&&t.hide(),e.widgetOptions.stickyHeaders_attachTo=$("#logs-slave"),t=$("#logs-contents-slave").tablesorter(e),t.trigger("pagerComplete.tsSticky",null),fetching_logs.slave?t.hide():enumerateMasterTableRows(),$("#logs-master").scroll(function(){var e=$("#logs-contents-master").data().tablesorter.sortList,t=$("#logs-contents-slave").data().tablesorter.sortList;if(!$("#sync-logs").is(":checked")||sync_scroll_block.master||sync_scroll_block.slave||0==e.length||0==t.length||e[0][0]>0||t[0][0]>0)return void console.log(sync_scroll_block);for(var s=$("#logs-master").scrollTop(),r=table_rows.master.pos,a=0,l=r.length-1;l>a;){var n=a+l>>1,o=r[n];o>s?l=n:a=a==n?l:n}for(s=parseFloat($($("#logs-contents-master > tbody > tr")[a]).find("td").attr("created")),r=table_rows.slave.time,a=0,l=r.length-1;l>a;){var n=a+l>>1,o=r[n];o>s?l=n:a=a==n?l:n}a>0?(t[0][1]>0&&(a=r.length-a),s=$($("#logs-contents-slave > tbody > tr")[a-1]).position().top-$("thead").height(),0>s&&(s=0)):s=t[0][1]>0?$($("#logs-contents-slave > tbody > tr")[r.length-1]).position().top-$("thead").height():0,scrollSlaveLogsDiv(s)}),$(".logs-contents").on("sortEnd",function(){$("#logs-master").trigger("scroll")}),$("#sync-logs").data().appCheckbox.button.on("click",function(){$("#logs-master").trigger("scroll")})}function scrollSlaveLogsDiv(e){var t=$("#logs-slave").scrollTop();t!=e&&(animating_scroll.slave?pending_scroll_offset.slave=e:(animating_scroll.slave=!0,$("#logs-slave").animate({scrollTop:e},500,function(){animating_scroll.slave=!1,pending_scroll_offset.slave>=0&&(e=pending_scroll_offset.slave,pending_scroll_offset.slave=-1,scrollSlaveLogsDiv(e))})))}function setupGraphs(e){for(var t=0;2>t;t++)graphs.push(new Rickshaw.Graph({element:document.getElementById(0===t?"chart-master":"chart-slave"),width:graph_width,height:graph_height,renderer:"area",stroke:!0,preserve:!0,stack:!1,min:0,max:1.5,interpolation:"linear",series:e[t]})),graphs[t].render();var s=(new Rickshaw.Graph.RangeSlider({graph:graphs,element:document.getElementById("preview")}),[]),r=[],a=[],l=[],n=[],o="glow",i=[],c=[];for(var t in graphs)s.push(new Rickshaw.Graph.HoverDetail({graph:graphs[t],xFormatter:function(e){return new Date(1e3*(e+smallest_time)).toString()}})),r.push(new Rickshaw.Graph.Legend({graph:graphs[t],element:document.getElementById("legend")})),a.push(new Rickshaw.Graph.Behavior.Series.Toggle({legend:r[t]})),l.push(new Rickshaw.Graph.Behavior.Series.Order({legend:r[t]})),n.push(new Rickshaw.Graph.Behavior.Series.Highlight({legend:r[t]})),i.push(new Rickshaw.Graph.Axis.Time({graph:graphs[t],ticksTreatment:o,timeFixture:new Rickshaw.Fixtures.Time.Local})),i[t].render(),c.push(new Rickshaw.Graph.Axis.Y({graph:graphs[t],tickFormat:Rickshaw.Fixtures.Number.formatKMBT,ticksTreatment:o})),c[t].render()}function scrollLogs(e){var t=$("#logs-contents-"+e).data().tablesorter.sortList;if(0==t[0][0]&&$("#sync-events-with-logs").is(":checked")){if(animating_scroll[e])return void(pending_scroll_offset[e]=current_min_time);for(var s=table_rows[e].time,r=0,a=s.length-1;a>r;){var l=r+a>>1,n=s[l];n>current_min_time?a=l:r=r==l?a:l}r=Math.max(r,1);var o=$($("#logs-contents-"+e+" > tbody > tr")[r-1]).position().top-$("thead").height();$("#logs-"+e).scrollTop()!=o?(animating_scroll[e]=!0,sync_scroll_block[e]=!0,$("#logs-"+e).animate({scrollTop:o},500,function(){animating_scroll[e]=!1,pending_scroll_offset[e]>=0?(pending_scroll_offset[e]=-1,scrollLogs(e)):setTimeout(function(){sync_scroll_block[e]=!1},100)})):setTimeout(function(){sync_scroll_block[e]=!1},100)}}function makeVerbatimText(e){return"<pre>"+e.replace(/</g,"&lt;").replace(/>/g,"&gt;")+"</pre>"}function enumerateMasterTableRows(){$("#logs-contents-master");table_rows.master.pos.length=0,table_rows.master.time.length=0,$("#logs-contents-master > tbody > tr").each(function(){table_rows.master.pos.push($(this).position().top),table_rows.master.time.push(parseFloat($(this).find("td").attr("created")))})}function enumerateSlaveRows(e){table_rows.slave.time.length=0;for(var t in e){var s=e[t];table_rows.slave.time.push(s.created)}table_rows.slave.time.sort()}function logsToHtml(e){var t=[];for(var s in e){var r=e[s],a='<tr class="log-record-'+r.levelname.toLowerCase()+'">';a+='<td created="'+r.created+'">'+formatDate(r.created).replace(" ","&nbsp;"),a+="</td><td>"+r.pathname+":"+r.lineno+"</td><td>",a+=r.name+"</td><td>"+makeVerbatimText(r.message)+"</td></tr>\n",t.push(a)}return $.parseHTML(t.join())}function renderLogs(e,t){var s=logsToHtml(e),r="master"==t?"master":"slave",a=$("#logs-contents-"+r+" > tbody").empty().append(s);$("#logs-loading-"+r).hide();$("#logs-contents-"+r).show();ui_is_setup&&(a.trigger("update"),"master"==r?(enumerateMasterTableRows(),fetching_logs.slave||$("#logs-master").trigger("scroll")):fetching_logs.master||$("#logs-master").trigger("scroll")),"slave"==r&&enumerateSlaveRows(e)}var graphs=[],graph_width=600,graph_height=380,table_rows={master:{pos:[],time:[]},slave:{time:[]}},animating_scroll={master:!1,slave:!1},pending_scroll_offset={master:-1,slave:-1},sync_scroll_block={master:!1,slave:!1};renderEvents=function(){setupUI();for(var e in graphs){var t=graphs[e];series_data[0][0][0]={x:current_min_time-smallest_time,y:0},series_data[0][0][1]={x:current_max_time-smallest_time,y:0},series_data[1][0][0]={x:current_min_time-smallest_time,y:0},series_data[1][0][1]={x:current_max_time-smallest_time,y:0},t.window.xMin=current_min_time-smallest_time,t.window.xMax=current_max_time-smallest_time,t.update()}},$(document).ready(function(){!fetching_events.master&&!fetching_events.slave&&nodes.length>0&&renderEvents()}),Rickshaw.Graph.RangeSlider=function(e){{var t=this.element=e.element;this.graph=e.graph}$(function(){$(t).slider({range:!0,min:0,max:elapsed_time,values:[0,elapsed_time],slide:function(e,t){current_min_time=t.values[0]+smallest_time,current_max_time=t.values[1]+smallest_time,$("#time-interval").text(formatDate(current_min_time)+" - "+formatDate(current_max_time)),fetchEvents(),scrollLogs("master"),scrollLogs("slave")}})})};